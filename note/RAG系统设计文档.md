# RAG系统设计文档

## 项目概述

基于text目录下的智能体设计模式文档，构建一个完整的检索增强生成(RAG)系统，提供智能的文档检索功能。

## 系统架构

### 整体架构

```
text目录 (原始文档)
    ↓ (文档分割器)
文档块集合
    ↓ (向量化处理器)
向量数据库 (ChromaDB)
    ↓
检索服务 → 重排序器 → 返回结果
    ↓
API接口 (FastAPI)
```

### 核心组件

1. **文档处理器**
   - 文档清洗和标准化
   - 智能分割策略
   - 元数据提取

2. **向量化服务**
   - 文本嵌入向量生成
   - 批量处理优化
   - 模型选择管理

3. **存储引擎**
   - 向量数据库管理
   - 元数据索引
   - 查询优化

4. **检索服务**
   - 语义检索
   - 混合检索策略
   - 结果重排序

5. **API服务**
   - RESTful接口
   - 查询参数处理
   - 结果格式化

## 文档分割策略

### 分割层级

#### 第一级：章节级别（粗粒度）
- **粒度**：文件级别
- **适用场景**：整章内容检索
- **特点**：保持完整上下文，但可能信息过载
- **文件大小**：1-30KB

#### 第二级：小节级别（推荐粒度）
- **粒度**：标题层级分割
- **分割规则**：
  - `# 章节标题` → 独立块
  - `## 小节标题` → 独立块
  - `### 子小节标题` → 独立块
- **内容范围**：200-800字符
- **特点**：保持语义完整性，检索精度适中

#### 第三级：段落级别（细粒度）
- **粒度**：自然段落分割
- **适用场景**：精确信息检索
- **特点**：检索精度高，但可能丢失上下文

### 具体分割规则

```python
分割算法：
1. 按标题层级分割
   - 遇到 #、##、### 标题时创建新块
   - 标题内容作为块的起始

2. 内容聚合
   - 最小块大小：200字符
   - 最大块大小：800字符
   - 在段落边界处分割

3. 特殊内容处理
   - 代码块：保持原样，不分割
   - 列表项：按列表项分割或聚合
   - 图片：保留描述文本
```

### 元数据设计

每个文档块包含完整的元数据信息：

```json
{
  "id": "chapter_07_section_02_block_01",
  "content": "实际文本内容...",
  "metadata": {
    "chapter_id": "07",
    "chapter_name": "第一章：提示链",
    "section_type": "模式概述",
    "section_level": 2,
    "file_path": "text/07-Chapter-01-Prompt-Chaining.md",
    "block_index": 1,
    "word_count": 350,
    "has_code": false,
    "has_list": true,
    "keywords": ["提示链", "分而治之", "模块化"]
  }
}
```

## 向量存储方案

### 数据库选择

- **主选**：ChromaDB（本地部署，轻量级）
- **备选**：Pinecone（云服务，生产环境）

### 向量化模型

- **模型选择**：`text-embedding-3-small` 或本地模型
- **向量维度**：1536维
- **批处理**：支持批量向量化

### 存储结构

```
chroma_db/
├── embeddings/          # 向量数据
├── metadata/           # 元数据索引
└── collections/        # 文档集合
```

## 检索接口设计

### API端点

#### 1. 语义检索
```http
POST /v1/search
Content-Type: application/json

{
  "query": "提示链模式的应用场景",
  "top_k": 5,
  "filter": {
    "chapter": "第一章",
    "section_type": "实际应用"
  },
  "use_reranker": true
}
```

#### 2. 关键词检索
```http
POST /v1/search/keyword
Content-Type: application/json

{
  "keywords": ["提示链", "分而治之"],
  "top_k": 10,
  "operator": "AND"  // AND/OR
}
```

#### 3. 混合检索
```http
POST /v1/search/hybrid
Content-Type: application/json

{
  "query": "智能体如何规划任务",
  "keywords": ["规划", "任务"],
  "top_k": 8,
  "alpha": 0.7  // 语义检索权重
}
```

### 返回格式

```json
{
  "results": [
    {
      "id": "chapter_12_section_01_block_03",
      "content": "检索到的文本内容...",
      "metadata": {
        "chapter_name": "第六章：规划",
        "section_type": "模式概述",
        "score": 0.92
      },
      "similarity_score": 0.85,
      "reranker_score": 0.92
    }
  ],
  "total_count": 15,
  "query_time": 0.125
}
```

## 重排序策略

### 重排序器集成

- **服务**：使用现有的reranker服务
- **模型**：Qwen3-Reranker-4B
- **作用**：提升检索结果的相关性

### 重排序流程

```
初始检索结果 (top_k=20)
    ↓
重排序器处理
    ↓
返回前N个结果 (top_k=5)
```

## 技术实现细节

### 开发环境

- **Python版本**：3.8+
- **主要依赖**：
  - chromadb：向量数据库
  - fastapi：API框架
  - sentence-transformers：向量化模型
  - requests：HTTP客户端

### 性能优化

1. **批量处理**：文档分割和向量化批量执行
2. **缓存策略**：频繁查询结果缓存
3. **索引优化**：元数据索引构建
4. **并发处理**：支持并行检索

### 质量保证

1. **分割质量**：人工验证分割边界
2. **检索质量**：相关性评估测试
3. **性能测试**：响应时间监控
4. **错误处理**：完善的异常处理机制

## 部署方案

### 开发环境

- 本地ChromaDB
- 本地向量化模型
- 开发服务器

### 生产环境

- 云向量数据库（可选）
- GPU加速向量化
- 负载均衡
- 监控告警

## 后续扩展

1. **多语言支持**：支持英文检索
2. **增量更新**：文档变更时的增量处理
3. **用户反馈**：基于用户反馈优化检索
4. **个性化**：用户偏好学习
5. **可视化**：检索结果可视化展示

---

*本文档将持续更新，记录RAG系统的设计和实现过程*