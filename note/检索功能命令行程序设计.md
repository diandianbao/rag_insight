# 检索功能命令行程序设计

## 设计目标

实现一个交互式的RAG检索命令行工具，能够：
- 从向量数据库中召回相关文档
- 使用reranker对召回结果进行精排
- 提供丰富的终端界面显示效果
- 支持多种检索模式和参数配置

## 技术选型

### CLI框架
推荐使用 **Typer + Rich** 组合：
- **Typer**: 现代化的CLI参数解析库，支持类型提示和自动帮助生成
- **Rich**: 强大的终端美化库，支持表格、进度条、语法高亮等

### 其他依赖
- **psycopg2**: PostgreSQL数据库连接
- **requests**: HTTP请求（用于reranker服务）
- **numpy**: 向量计算

## 架构设计

### 核心模块

```
rag_cli/
├── main.py              # 主入口，CLI命令定义
├── interactive.py       # 交互式命令行界面
├── core/
│   ├── __init__.py
│   ├── retriever.py     # 向量检索器
│   ├── reranker.py      # 重排序器
│   ├── display.py       # 结果显示模块
│   └── session.py       # 交互会话管理
├── models/
│   ├── __init__.py
│   ├── config.py        # 配置模型
│   └── results.py       # 结果数据模型
└── utils/
    ├── __init__.py
    ├── database.py      # 数据库工具
    ├── validation.py    # 参数验证
    └── prompts.py       # 交互式提示工具
```

### 核心类设计

#### 1. RAGRetriever (向量检索器)
```python
class RAGRetriever:
    def __init__(self, config: RetrieverConfig):
        self.config = config
        self.vector_store = PgVectorStore(config.vector_store_config)

    def search(self, query: str, top_k: int = 10) -> List[SearchResult]:
        """基础向量检索"""

    def hybrid_search(self, query: str, top_k: int = 10) -> List[SearchResult]:
        """混合检索（向量 + 关键词）"""
```

#### 2. Reranker (重排序器)
```python
class Reranker:
    def __init__(self, config: RerankerConfig):
        self.config = config

    def rerank(self, query: str, documents: List[SearchResult]) -> List[RerankedResult]:
        """对检索结果进行重排序"""

    def score_document(self, query: str, document: SearchResult) -> float:
        """计算单个文档的reranker分数"""
```

#### 3. ResultDisplay (结果显示器)
```python
class ResultDisplay:
    def __init__(self, theme: DisplayTheme = None):
        self.console = Console()
        self.theme = theme or DisplayTheme()

    def show_search_results(self, results: List[SearchResult]):
        """显示检索结果"""

    def show_comparison(self, before: List[SearchResult], after: List[RerankedResult]):
        """显示reranker前后的对比"""

    def show_document_detail(self, document: SearchResult):
        """显示单个文档的详细信息"""
```

#### 4. InteractiveSession (交互会话管理器)
```python
class InteractiveSession:
    def __init__(self, config: SessionConfig):
        self.config = config
        self.retriever = RAGRetriever(config.retriever_config)
        self.reranker = Reranker(config.reranker_config)
        self.display = ResultDisplay(config.display_config)
        self.history = []  # 查询历史

    def start(self):
        """启动交互式会话"""

    def process_query(self, query: str) -> bool:
        """处理单个查询"""

    def show_history(self):
        """显示查询历史"""

    def clear_history(self):
        """清空查询历史"""

    def export_results(self, format: str = "json"):
        """导出当前结果"""
```

## 功能特性

### 1. 检索模式
- **向量检索**: 纯向量相似度搜索
- **混合检索**: 向量 + 关键词组合搜索
- **语义检索**: 使用更复杂的语义匹配

### 2. 重排序支持
- **本地reranker**: 使用本地模型进行重排序
- **远程reranker**: 调用远程reranker服务
- **多模型支持**: 支持多种reranker模型

### 3. 显示功能
- **表格视图**: 以表格形式显示检索结果
- **对比视图**: 显示reranker前后的排序变化
- **文档详情**: 详细显示单个文档内容
- **统计信息**: 显示检索统计和性能指标

### 4. 交互式功能
- **交互式会话**: 启动持续交互的命令行界面
- **查询历史**: 记录和查看历史查询
- **结果筛选**: 根据分数、文档类型等筛选结果
- **导出功能**: 将结果导出为JSON或Markdown
- **会话管理**: 保存和加载会话状态
- **实时配置**: 在会话中动态修改配置

## CLI命令设计

### 主要命令

```bash
# 基础检索（单次命令）
rag-cli search "查询内容"

# 检索并重排序
rag-cli search "查询内容" --rerank

# 指定检索数量
rag-cli search "查询内容" --top-k 20

# 混合检索模式
rag-cli search "查询内容" --mode hybrid

# 显示详细信息
rag-cli search "查询内容" --verbose

# 交互模式（主要使用方式）
rag-cli interactive

# 从文件批量查询
rag-cli batch queries.txt
```

### 配置命令

```bash
# 显示配置
rag-cli config show

# 设置数据库连接
rag-cli config set database.url postgresql://localhost/hello_vector

# 设置reranker服务
rag-cli config set reranker.endpoint http://localhost:8000/rerank
```

## 配置设计

### 配置文件格式 (YAML)
```yaml
vector_store:
  database_url: "postgresql://localhost/hello_vector"
  table_name: "document_chunks"
  embedding_model: "qwen3-embedding:4b"
  embedding_endpoint: "http://localhost:11434/api/embeddings"

reranker:
  enabled: true
  endpoint: "http://localhost:8000/rerank"
  model: "bge-reranker-large"
  timeout: 30

display:
  theme: "dark"
  max_results: 10
  show_scores: true
  highlight_keywords: true
```

## 交互式界面设计

### 启动界面
```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RAG 检索交互式命令行                             │
├─────────────────────────────────────────────────────────────────────────┤
│ 版本: 1.0.0 | 数据库: 已连接 | Reranker: 已启用                         │
│ 输入 'help' 查看可用命令，'quit' 退出                                  │
└─────────────────────────────────────────────────────────────────────────┘

> "
```

### 交互式命令
```
可用命令:
  search <query>      - 执行检索
  rerank <query>      - 检索并重排序
  history            - 显示查询历史
  detail <id>        - 查看文档详情
  config             - 显示当前配置
  set <key> <value>  - 修改配置
  export <format>    - 导出结果
  clear              - 清空屏幕
  help               - 显示帮助
  quit               - 退出程序
```

### 检索结果表格
```
┌── RAG 检索结果 ──────────────────────────────────────────────────────────┐
│ 查询: "Python中的异步编程"                                                │
│ 召回数量: 15 | 重排序: 是 | 检索时间: 0.45s                              │
├─────┬─────────────┬─────────────────────────────────┬─────────┬──────────┤
│ 排名 │ 文档ID      │ 标题                           │ 相似度  │ Reranker │
├─────┼─────────────┼─────────────────────────────────┼─────────┼──────────┤
│  1  │ chap_01_003 │ Python异步编程基础             │ 0.892   │ 0.956    │
│  2  │ chap_02_015 │ asyncio使用指南                │ 0.845   │ 0.912    │
│  3  │ chap_03_008 │ 协程与事件循环                 │ 0.812   │ 0.889    │
└─────┴─────────────┴─────────────────────────────────┴─────────┴──────────┘

输入 'detail 1' 查看第一个文档的详细信息，或输入新的查询:
> "
```

### 文档详情显示
```
┌── 文档详情 ──────────────────────────────────────────────────────────────┐
│ 文档ID: chap_01_003                                                      │
│ 标题: Python异步编程基础                                                 │
│ 来源: text/python_async.md                                              │
│ 相似度: 0.892 | Reranker分数: 0.956                                     │
├──────────────────────────────────────────────────────────────────────────┤
│ Python中的异步编程主要通过async/await关键字实现。在Python 3.5+版本中，  │
│ 引入了原生的异步支持，使得编写异步代码变得更加简洁和直观。              │
│                                                                          │
│ 主要特性包括：                                                           │
│ • async def 定义异步函数                                                 │
│ • await 等待异步操作完成                                                │
│ • asyncio 库提供事件循环和任务管理                                      │
└──────────────────────────────────────────────────────────────────────────┘

输入 'back' 返回结果列表，或输入新的查询:
> "
```

### 查询历史显示
```
┌── 查询历史 ──────────────────────────────────────────────────────────────┐
│ 序号 │ 查询内容                          │ 时间                │ 结果数 │
├─────┼───────────────────────────────────┼─────────────────────┼───────┤
│  1  │ Python异步编程                    │ 2024-01-15 10:30:15 │   12  │
│  2  │ 协程与事件循环                    │ 2024-01-15 10:31:22 │    8  │
│  3  │ asyncio使用指南                   │ 2024-01-15 10:32:45 │   15  │
└─────┴───────────────────────────────────┴─────────────────────┴───────┘

输入 'load 1' 重新加载第一个查询的结果:
> "
```

## 实现计划

### 第一阶段：基础检索功能
1. 实现向量检索核心逻辑
2. 创建基础的CLI界面
3. 支持简单的结果显示

### 第二阶段：重排序功能
1. 集成reranker服务
2. 实现重排序逻辑
3. 添加对比显示功能

### 第三阶段：界面优化
1. 使用Rich库美化界面
2. 添加交互式功能
3. 实现配置管理

### 第四阶段：高级功能
1. 支持多种检索模式
2. 添加导出功能
3. 性能优化和错误处理

## 技术挑战

1. **性能优化**: 大规模向量检索的性能优化
2. **内存管理**: 处理大量检索结果时的内存使用
3. **用户体验**: 提供流畅的交互体验
4. **错误处理**: 优雅处理各种异常情况

这个设计提供了一个完整的RAG检索命令行工具的实现方案，既满足了功能性需求，又提供了良好的用户体验。